<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TuniFlix</title>
  <meta name="description" content="Stream movies and TV shows with multiple player options" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¬</text></svg>">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#e50914',
            'primary-hover': '#f40612',
            dark: '#0f0f0f',
            darker: '#0a0a0a',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in',
            'spin-slow': 'spin 2s linear infinite',
          },
          keyframes: {
            fadeIn: {
              from: { opacity: 0 },
              to: { opacity: 1 },
            },
            spin: {
              to: { transform: 'rotate(360deg)' },
            }
          }
        }
      }
    }
  </script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
</head>
<body class="min-h-screen bg-darker text-gray-100 font-sans" oncontextmenu="return false;">
  <style>
    
    .pin-input {
      width: 40px;
      height: 50px;
      font-size: 1.5rem;
      text-align: center;
      margin: 0 5px;
      border: 1px solid #333;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .pin-input:focus {
      outline: 2px solid var(--primary);
      border-color: transparent;
    }
  </style>
  <!-- Profile Selection Modal -->
  <div id="profileModal" class="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-6 text-center">Who's watching?</h2>
      
      <div id="profilesContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-8">
        <!-- Profiles will be loaded here -->
      </div>
      
      <div class="text-center">
        <button id="addProfileBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md transition-colors">
          <i class="fas fa-plus mr-2"></i>Add Profile
        </button>
      </div>
    </div>
  </div>

  <!-- Add Profile Modal -->
  <div id="addProfileModal" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-6 text-center">Add Profile</h2>
      
      <div class="mb-4">
        <label class="block text-gray-400 mb-2">Profile Name</label>
        <input type="text" id="profileName" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
      </div>
      
      <div class="mb-6">
        <label class="block text-gray-400 mb-2">Choose Avatar</label>
        <div class="grid grid-cols-4 gap-3">
          <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Max" class="w-full h-auto rounded-lg cursor-pointer transition-transform hover:scale-105 profile-avatar" data-avatar="Max">
          <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Bella" class="w-full h-auto rounded-lg cursor-pointer transition-transform hover:scale-105 profile-avatar" data-avatar="Bella">
          <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Charlie" class="w-full h-auto rounded-lg cursor-pointer transition-transform hover:scale-105 profile-avatar" data-avatar="Charlie">
          <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Luna" class="w-full h-auto rounded-lg cursor-pointer transition-transform hover:scale-105 profile-avatar" data-avatar="Luna">
          <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Leo" class="w-full h-auto rounded-lg cursor-pointer transition-transform hover:scale-105 profile-avatar" data-avatar="Leo">
          <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Milo" class="w-full h-auto rounded-lg cursor-pointer transition-transform hover:scale-105 profile-avatar" data-avatar="Milo">
          <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Zoe" class="w-full h-auto rounded-lg cursor-pointer transition-transform hover:scale-105 profile-avatar" data-avatar="Zoe">
          <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=Oliver" class="w-full h-auto rounded-lg cursor-pointer transition-transform hover:scale-105 profile-avatar" data-avatar="Oliver">
        </div>
      </div>
      
      <div class="mb-6">
        <label class="block text-gray-400 mb-2">Set 4-digit PIN</label>
        <div class="flex justify-center">
          <input type="password" maxlength="1" class="pin-input" pattern="[0-9]">
          <input type="password" maxlength="1" class="pin-input" pattern="[0-9]">
          <input type="password" maxlength="1" class="pin-input" pattern="[0-9]">
          <input type="password" maxlength="1" class="pin-input" pattern="[0-9]">
        </div>
      </div>
      
      <div class="flex justify-between">
        <button id="cancelAddProfileBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md transition-colors">
          Cancel
        </button>
        <button id="saveProfileBtn" class="bg-primary hover:bg-primary-hover px-4 py-2 rounded-md transition-colors">
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- PIN Entry Modal -->
  <div id="pinModal" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-xl p-6 max-w-md w-full">
      <h2 class="text-2xl font-bold mb-6 text-center">Enter PIN</h2>
      <p class="text-gray-400 text-center mb-6" id="pinProfileName"></p>
      
      <div class="flex justify-center mb-6">
        <input type="password" maxlength="1" class="pin-input" pattern="[0-9]">
        <input type="password" maxlength="1" class="pin-input" pattern="[0-9]">
        <input type="password" maxlength="1" class="pin-input" pattern="[0-9]">
        <input type="password" maxlength="1" class="pin-input" pattern="[0-9]">
      </div>
      
      <p id="pinError" class="text-red-500 text-center mb-4 hidden">Incorrect PIN. Please try again.</p>
      
      <div class="text-center">
        <button id="cancelPinBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md mr-2 transition-colors">
          Cancel
        </button>
        <button id="submitPinBtn" class="bg-primary hover:bg-primary-hover px-4 py-2 rounded-md transition-colors">
          Submit
        </button>
      </div>
    </div>
  </div>

  <!-- Movie Details Modal -->
  <div id="detailsModal" class="fixed inset-0 z-50 bg-black/90 hidden overflow-y-auto p-4">

    <div class="max-w-4xl mx-auto bg-gray-900 rounded-xl overflow-hidden">
      <button id="closeDetailsBtn" class="absolute top-4 right-4 bg-black/50 rounded-full p-2 z-10 hover:bg-black/70 transition-colors">
        <i class="fas fa-times text-xl"></i>
      </button>
      
      <div class="relative h-64 md:h-96 w-full">
        <img id="detailsBackdrop" src="" alt="" class="w-full h-full object-cover">
        <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/70 to-transparent"></div>
        <div class="absolute bottom-0 left-0 p-6 w-full">
          <h2 id="detailsTitle" class="text-3xl md:text-4xl font-bold mb-2"></h2>
          <div id="detailsMeta" class="flex items-center gap-3 text-sm mb-4"></div>
          <div class="flex gap-3">
            <button id="playNowBtn" class="bg-primary hover:bg-primary-hover px-6 py-2 rounded-md font-medium flex items-center gap-2 transition-colors">
              <i class="fas fa-play"></i> Watch Now
            </button>
        
          </div>
        </div>
      </div>
      
      <div class="p-6">
        <div class="flex flex-col md:flex-row gap-6">
          <div class="md:w-1/3">
            <img id="detailsPoster" src="" alt="" class="w-full rounded-lg shadow-lg hidden md:block">
          </div>
          <div class="md:w-2/3">
            <h3 class="text-xl font-bold mb-3">Overview</h3>
            <p id="detailsOverview" class="text-gray-300 mb-6"></p>
            
            <div id="detailsInfo" class="grid grid-cols-2 gap-4 mb-6"></div>
            
            <div id="detailsCast" class="mb-6">
              <h4 class="font-bold mb-3">Top Cast</h4>
              <div class="flex gap-4 overflow-x-auto pb-2">
                <!-- Cast will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="mainContent" class="hidden flex-grow">
    <!-- Hero Section -->
    <div class="relative h-96 md:h-screen max-h-[80vh] w-full overflow-hidden">
      <div id="heroBackdrop" class="absolute inset-0 bg-gray-900">
        <img src="" alt="" class="w-full h-full object-cover opacity-50 blur-load" onload="this.classList.add('loaded')">
      </div>
      
      <div class="absolute inset-0 bg-gradient-to-t from-darker via-darker/30 to-transparent"></div>
      
      <div class="container mx-auto px-4 h-full flex items-center relative z-10">
        <div class="max-w-2xl">
          <h1 id="heroTitle" class="text-4xl md:text-6xl font-bold mb-4"></h1>
          <p id="heroOverview" class="text-lg md:text-xl text-gray-300 mb-6 line-clamp-3"></p>
          <div class="flex gap-3">
            <button id="heroPlayBtn" class="bg-primary hover:bg-primary-hover px-6 py-3 rounded-md font-medium flex items-center gap-2 transition-colors">
              <i class="fas fa-play"></i> Watch Now
            </button>
            <button id="heroInfoBtn" class="bg-gray-800/80 hover:bg-gray-700/80 px-4 py-3 rounded-md flex items-center gap-2 transition-colors">
              <i class="fas fa-info-circle"></i> More Info
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 py-8 md:py-12">
      <!-- Header with Profile Button -->
      <header class="mb-8 flex items-center justify-between">
        <button id="switchProfileBtn" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-md flex items-center gap-2 transition-colors">
          <img id="currentProfileAvatar" src="" class="w-6 h-6 rounded">
          <span id="currentProfileName" class="font-medium"></span>
        </button>
        
        <div class="flex items-center gap-4">
          <button id="refreshBtn" class="text-gray-400 hover:text-white transition-colors">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </header>

      <!-- Search Bar -->
      <div class="relative max-w-2xl mx-auto mb-12">
        <div class="relative">
          <input 
            id="searchInput" 
            type="text" 
            placeholder="Search movies or TV shows..." 
            class="w-full bg-gray-900/80 backdrop-blur-lg rounded-xl px-5 py-4 text-lg border border-gray-800 focus:border-transparent focus:ring-2 focus:ring-primary transition-all duration-200"
            autocomplete="off"
            onkeyup="debounceSearch()"
          />
          <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
            <i class="fas fa-search"></i>
          </div>
        </div>
        <div id="searchResults" class="absolute left-0 right-0 mt-2 bg-gray-950/95 rounded-xl shadow-2xl max-h-96 overflow-y-auto hidden z-50 fade-in border border-gray-800"></div>
      </div>

      <!-- Continue Watching -->
      <section class="mb-12">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Continue Watching</h2>
        </div>
        <div class="relative">
          <button id="prevBtn" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 bg-black/70 hover:bg-black/90 w-10 h-10 rounded-full flex items-center justify-center z-10 transition-colors hidden">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div id="continueContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6 overflow-x-auto scroll-smooth scrollbar-hide pb-4">
            <!-- Items will be inserted here by JavaScript -->
          </div>
          <button id="nextBtn" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 bg-black/70 hover:bg-black/90 w-10 h-10 rounded-full flex items-center justify-center z-10 transition-colors hidden">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </section>

      <!-- Latest Additions -->
      <section class="mb-12">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Latest Additions</h2>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
          <!-- Latest items will be loaded here -->
          <div id="latestItems" class="contents">
            <!-- Content loaded via JS -->
          </div>
        </div>
      </section>

      <!-- Popular Movies -->
      <section class="mb-12">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Popular Movies</h2>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
          <!-- Popular movies will be loaded here -->
          <div id="popularMovies" class="contents">
            <!-- Content loaded via JS -->
          </div>
        </div>
      </section>

      <!-- Trending TV Shows -->
      <section class="mb-12">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Trending TV Shows</h2>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
          <!-- Trending shows will be loaded here -->
          <div id="trendingShows" class="contents">
            <!-- Content loaded via JS -->
          </div>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <footer class="bg-black/50 py-6 text-center text-gray-500 text-sm">
      <div class="container mx-auto px-4">
        <p>Made with <3 by Overflow</p>
      </div>
    </footer>
  </div>

  <!-- Player Modal -->
  <div id="playerModal" class="fixed inset-0 bg-black/95 z-[100] hidden flex flex-col">
    <div class="container mx-auto px-4 py-6 h-full flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 id="playerTitle" class="text-lg font-bold"></h3>
        <button id="closePlayerBtn" class="text-3xl leading-none hover:text-gray-400 transition">&times;</button>
      </div>
      
      <!-- Player Selector -->
      <div class="absolute top-4 right-4 z-10 bg-black/70 px-3 py-1 rounded-md">
        <select id="playerType" class="bg-gray-800 text-white border-none px-2 py-1 rounded text-sm focus:ring-2 focus:ring-primary">
          <option value="videasy">Player #1 (No Ads)</option>
          <option value="vidsrc">Player #2 (Contains Ads)</option>
        </select>
      </div>
      
      <div class="flex-grow w-full bg-black/50 rounded-xl overflow-hidden">
        <iframe id="player" class="w-full h-full" allowfullscreen referrerpolicy="no-referrer"></iframe>
      </div>
      <div id="playerInfo" class="mt-3 text-gray-400 text-sm"></div>
      
      <!-- Episode Navigation -->
      <div id="episodeNav" class="hidden mt-4 p-4 bg-gray-900/80 rounded-lg">
        <div class="flex flex-col space-y-4">
          <div class="flex justify-between items-center">
            <button id="prevEpisodeBtn" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md transition-colors" disabled>
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-2">
                <label for="seasonSelect" class="text-sm">Season:</label>
                <select id="seasonSelect" class="bg-gray-800 border border-gray-700 px-2 py-1 rounded text-sm focus:ring-2 focus:ring-primary">
                  <!-- Seasons will be populated here -->
                </select>
              </div>
              <div class="flex items-center gap-2">
                <label for="episodeSelect" class="text-sm">Episode:</label>
                <select id="episodeSelect" class="bg-gray-800 border border-gray-700 px-2 py-1 rounded text-sm focus:ring-2 focus:ring-primary">
                  <!-- Episodes will be populated here -->
                </select>
              </div>
            </div>
            
            <button id="nextEpisodeBtn" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md transition-colors">
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          
          <div class="flex justify-center">
            <button id="showEpisodesBtn" class="text-sm text-gray-400 hover:text-white transition-colors">
              Show All Episodes
            </button>
          </div>
        </div>
      </div>
      
      <!-- Episode List - Initially hidden -->
      <div id="episodeSelector" class="hidden mt-4 bg-gray-900/80 border border-gray-800 p-4 rounded-xl max-h-64 overflow-y-auto">
        <h4 class="font-medium mb-3">All Episodes</h4>
        <div id="episodesList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
      </div>
    </div>
  </div>

  <script>
    // ================= Config =================
    const TMDB_API_KEY = '7045bc4055c6293e84534dd8f6dbb024'; 
    const TMDB = axios.create({ 
      baseURL: 'https://api.themoviedb.org/3',
      params: { 
        api_key: TMDB_API_KEY,
        language: 'en-US',
      },
      timeout: 5000
    });

    const state = {
      searchTimeout: null,
      currentShow: null,
      currentTVShow: null,
      currentSeason: 1,
      currentEpisode: 1,
      totalSeasons: 1,
      totalEpisodes: 0,
      episodes: [],
      continueIndex: 0,
      currentProfile: null,
      selectedAvatar: null,
      selectedProfileForPin: null,
      currentPlayer: 'videasy', // Default to VidEasy
      heroContent: null,
      latestMovies: [],
      popularMovies: [],
      trendingShows: []
    };

    const els = {
      profileModal: document.getElementById('profileModal'),
      profilesContainer: document.getElementById('profilesContainer'),
      addProfileBtn: document.getElementById('addProfileBtn'),
      addProfileModal: document.getElementById('addProfileModal'),
      profileName: document.getElementById('profileName'),
      cancelAddProfileBtn: document.getElementById('cancelAddProfileBtn'),
      saveProfileBtn: document.getElementById('saveProfileBtn'),
      pinModal: document.getElementById('pinModal'),
      pinProfileName: document.getElementById('pinProfileName'),
      pinError: document.getElementById('pinError'),
      cancelPinBtn: document.getElementById('cancelPinBtn'),
      submitPinBtn: document.getElementById('submitPinBtn'),
      mainContent: document.getElementById('mainContent'),
      switchProfileBtn: document.getElementById('switchProfileBtn'),
      currentProfileName: document.getElementById('currentProfileName'),
      currentProfileAvatar: document.getElementById('currentProfileAvatar'),
      continueContainer: document.getElementById('continueContainer'),
      searchInput: document.getElementById('searchInput'),
      searchResults: document.getElementById('searchResults'),
      playerModal: document.getElementById('playerModal'),
      player: document.getElementById('player'),
      playerTitle: document.getElementById('playerTitle'),
      playerInfo: document.getElementById('playerInfo'),
      playerType: document.getElementById('playerType'),
      episodeSelector: document.getElementById('episodeSelector'),
      episodesList: document.getElementById('episodesList'),
      seasonSelect: document.getElementById('seasonSelect'),
      episodeSelect: document.getElementById('episodeSelect'),
      episodeNav: document.getElementById('episodeNav'),
      prevEpisodeBtn: document.getElementById('prevEpisodeBtn'),
      nextEpisodeBtn: document.getElementById('nextEpisodeBtn'),
      showEpisodesBtn: document.getElementById('showEpisodesBtn'),
      closePlayerBtn: document.getElementById('closePlayerBtn'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      detailsModal: document.getElementById('detailsModal'),
      closeDetailsBtn: document.getElementById('closeDetailsBtn'),
      detailsBackdrop: document.getElementById('detailsBackdrop'),
      detailsPoster: document.getElementById('detailsPoster'),
      detailsTitle: document.getElementById('detailsTitle'),
      detailsOverview: document.getElementById('detailsOverview'),
      detailsMeta: document.getElementById('detailsMeta'),
      detailsInfo: document.getElementById('detailsInfo'),
      detailsCast: document.getElementById('detailsCast'),
      playNowBtn: document.getElementById('playNowBtn'),
      trailerBtn: document.getElementById('trailerBtn'),
      heroBackdrop: document.getElementById('heroBackdrop'),
      heroTitle: document.getElementById('heroTitle'),
      heroOverview: document.getElementById('heroOverview'),
      heroPlayBtn: document.getElementById('heroPlayBtn'),
      heroInfoBtn: document.getElementById('heroInfoBtn'),
      latestItems: document.getElementById('latestItems'),
      popularMovies: document.getElementById('popularMovies'),
      trendingShows: document.getElementById('trendingShows'),
      refreshBtn: document.getElementById('refreshBtn')
    };

    // ================= Player Functions =================
    function buildVidEasyUrl(type, id, season, episode) {
      if (type === 'movie') {
        return `https://player.videasy.net/movie/${id}?autoplay=1`;
      } else if (type === 'tv') {
        return `https://player.videasy.net/tv/${id}/${season}/${episode}?autoplay=1`;
      } else if (type === 'anime') {
        return `https://player.videasy.net/anime/${id}/${episode}?dub=false&autoplay=1`;
      }
    }

    function buildVidSrcUrl(type, id, season, episode) {
      if (type === 'movie') {
        return `https://vidsrc.xyz/embed/movie/${id}?autoplay=1`;
      } else {
        return `https://vidsrc.xyz/embed/tv/${id}/${season}-${episode}?autoplay=1`;
      }
    }

    function openModal() { 
      els.playerModal.classList.remove('hidden'); 
      document.body.style.overflow = 'hidden'; 
    }
    
    function closeModal() { 
      els.player.src = ''; 
      els.playerModal.classList.add('hidden'); 
      document.body.style.overflow = 'auto'; 
      
      if (state.currentShow) {
        const list = getContinue();
        const key = `${state.currentShow.type}:${state.currentShow.ids.tmdb}` + 
                   (state.currentShow.type === 'episode' ? `:S${state.currentShow.season}:E${state.currentShow.episode}` : '');
        
        const updated = list.map(item => {
          if (item._k === key) {
            return { ...item, progress: Math.floor(Math.random() * 100) };
          }
          return item;
        });
        
        setContinue(updated);
      }
    }

    function openDetailsModal() {
      els.detailsModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeDetailsModal() {
      els.detailsModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // ================= Profile Management =================
    const PROFILES_KEY = 'tuniflix_profiles';
    
    function getProfiles() {
      try {
        return JSON.parse(localStorage.getItem(PROFILES_KEY)) || [];
      } catch {
        return [];
      }
    }
    
    function saveProfiles(profiles) {
      localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
    }
    
    function renderProfiles() {
      const profiles = getProfiles();
      els.profilesContainer.innerHTML = '';
      
      if (profiles.length === 0) {
        els.profilesContainer.innerHTML = `
          <div class="col-span-full text-center text-gray-500 py-8">
            No profiles found. Create one to get started.
          </div>`;
      } else {
        profiles.forEach(profile => {
          const profileEl = document.createElement('div');
          profileEl.className = 'flex flex-col items-center cursor-pointer group';
          profileEl.innerHTML = `
            <div class="relative mb-2">
              <img src="${profile.avatar}" class="w-20 h-20 md:w-24 md:h-24 rounded-lg object-cover group-hover:ring-2 group-hover:ring-primary transition-all">
              <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                <span class="text-white font-medium">Select</span>
              </div>
            </div>
            <span class="text-gray-300">${profile.name}</span>
          `;
          profileEl.addEventListener('click', () => selectProfile(profile));
          els.profilesContainer.appendChild(profileEl);
        });
      }
    }
    
    function selectProfile(profile) {
      if (profile.pin) {
        // Show PIN entry modal
        state.selectedProfileForPin = profile;
        els.pinProfileName.textContent = profile.name;
        els.pinModal.classList.remove('hidden');
        
        // Clear any previous PIN inputs and error
        const pinInputs = els.pinModal.querySelectorAll('.pin-input');
        pinInputs.forEach(input => input.value = '');
        els.pinError.classList.add('hidden');
        
        // Focus first PIN input
        if (pinInputs.length > 0) {
          pinInputs[0].focus();
        }
      } else {
        // No PIN required, proceed
        startSession(profile);
      }
    }
    
    function startSession(profile) {
      state.currentProfile = profile;
      els.profileModal.classList.add('hidden');
      els.mainContent.classList.remove('hidden');
      
      // Update profile info in header
      els.currentProfileName.textContent = profile.name;
      els.currentProfileAvatar.src = profile.avatar;
      
      // Initialize continue watching for this profile
      renderContinue();
      loadHeroContent();
      loadLatestContent();
      loadPopularMovies();
      loadTrendingShows();
    }
    
    function setupAvatarSelection() {
      const avatars = document.querySelectorAll('#addProfileModal .profile-avatar');
      avatars.forEach(avatar => {
        avatar.addEventListener('click', () => {
          avatars.forEach(a => a.classList.remove('selected'));
          avatar.classList.add('selected');
          state.selectedAvatar = avatar.getAttribute('data-avatar');
        });
      });
    }
    
    function setupPinInputs() {
      // For add profile modal
      const addProfilePinInputs = els.addProfileModal.querySelectorAll('.pin-input');
      addProfilePinInputs.forEach((input, index) => {
        input.addEventListener('input', () => {
          if (input.value.length === 1 && index < addProfilePinInputs.length - 1) {
            addProfilePinInputs[index + 1].focus();
          }
        });
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
            addProfilePinInputs[index - 1].focus();
          }
        });
      });
      
      // For PIN entry modal
      const pinInputs = els.pinModal.querySelectorAll('.pin-input');
      pinInputs.forEach((input, index) => {
        input.addEventListener('input', () => {
          if (input.value.length === 1 && index < pinInputs.length - 1) {
            pinInputs[index + 1].focus();
          }
        });
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
            pinInputs[index - 1].focus();
          }
        });
      });
    }
    
    function addNewProfile() {
      const name = els.profileName.value.trim();
      if (!name) {
        alert('Please enter a profile name');
        return;
      }
      
      if (!state.selectedAvatar) {
        alert('Please select an avatar');
        return;
      }
      
      const pinInputs = els.addProfileModal.querySelectorAll('.pin-input');
      let pin = '';
      pinInputs.forEach(input => {
        if (input.value && input.value.length === 1) {
          pin += input.value;
        }
      });
      
      // Validate PIN if provided (must be 4 digits or empty)
      if (pin && pin.length !== 4) {
        alert('PIN must be exactly 4 digits');
        return;
      }
      
      const profiles = getProfiles();
      const newProfile = {
        id: Date.now().toString(),
        name,
        avatar: `https://api.dicebear.com/7.x/adventurer/svg?seed=${state.selectedAvatar}`,
        pin: pin || null,
        continueWatching: []
      };
      
      profiles.push(newProfile);
      saveProfiles(profiles);
      
      // Reset form
      els.profileName.value = '';
      const avatars = document.querySelectorAll('#addProfileModal .profile-avatar');
      avatars.forEach(a => a.classList.remove('selected'));
      state.selectedAvatar = null;
      pinInputs.forEach(input => input.value = '');
      
      // Close add profile modal and refresh profiles list
      els.addProfileModal.classList.add('hidden');
      renderProfiles();
    }
    
    function verifyPin() {
      const pinInputs = els.pinModal.querySelectorAll('.pin-input');
      let enteredPin = '';
      pinInputs.forEach(input => {
        if (input.value && input.value.length === 1) {
          enteredPin += input.value;
        }
      });
      
      if (enteredPin === state.selectedProfileForPin.pin) {
        // Correct PIN, start session
        els.pinModal.classList.add('hidden');
        startSession(state.selectedProfileForPin);
        state.selectedProfileForPin = null;
      } else {
        // Incorrect PIN
        els.pinError.classList.remove('hidden');
        pinInputs.forEach(input => input.value = '');
        if (pinInputs.length > 0) {
          pinInputs[0].focus();
        }
      }
    }
    
    function switchProfile() {
      els.mainContent.classList.add('hidden');
      els.profileModal.classList.remove('hidden');
    }

    // ================= Continue Watching =================
    const VISIBLE_ITEMS = 5;
    
    function getContinue(){
      if (!state.currentProfile) return [];
      return state.currentProfile.continueWatching || [];
    }
    
    function setContinue(list) {
      if (!state.currentProfile) return;
      
      const profiles = getProfiles();
      const profileIndex = profiles.findIndex(p => p.id === state.currentProfile.id);
      
      if (profileIndex >= 0) {
        profiles[profileIndex].continueWatching = list.slice(0, 12);
        saveProfiles(profiles);
        state.currentProfile = profiles[profileIndex];
      }
      
      renderContinue();
    }
    
    function recordContinue(item) {
      const list = getContinue();
      
      // For TV shows, we'll store them as a single entry with the latest episode
      let key = `${item.type}:${item.ids.tmdb}`;
      if (item.type === 'episode') {
        key = `tv:${item.ids.tmdb}`; // Change key to just the show ID
        
        // Check if we already have this show in continue watching
        const existingShowIndex = list.findIndex(x => x._k === key);
        
        if (existingShowIndex >= 0) {
          // Update the existing show with the latest episode
          list[existingShowIndex] = { 
            ...list[existingShowIndex],
            type: 'tv',
            title: item.title,
            year: item.year,
            poster: item.poster,
            ids: { tmdb: item.ids.tmdb },
            lastSeason: item.season,
            lastEpisode: item.episode,
            _k: key,
            updatedAt: Date.now(),
            progress: 0
          };
        } else {
          // Add new show entry
          list.unshift({ 
            type: 'tv',
            title: item.title,
            year: item.year,
            poster: item.poster,
            ids: { tmdb: item.ids.tmdb },
            lastSeason: item.season,
            lastEpisode: item.episode,
            _k: key,
            updatedAt: Date.now(),
            progress: 0
          });
        }
      } else {
        // For movies, just add/update as normal
        const existingIndex = list.findIndex(x => x._k === key);
        if (existingIndex >= 0) {
          list[existingIndex] = { ...item, _k: key, updatedAt: Date.now() };
        } else {
          item._k = key;
          item.updatedAt = Date.now();
          list.unshift(item);
        }
      }
      
      setContinue(list);
    }
    
    function renderContinue() {
      const list = getContinue().sort((a, b) => b.updatedAt - a.updatedAt);
      els.continueContainer.innerHTML = '';
      
      if (list.length === 0) { 
        els.continueContainer.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
            </svg>
            <p>Nothing to continue watching</p>
            <p class="text-sm mt-1">Start watching something and it will appear here</p>
          </div>`;
        
        els.prevBtn.classList.add('hidden');
        els.nextBtn.classList.add('hidden');
        return; 
      }
      
      // Show/hide navigation buttons based on item count
      if (list.length > VISIBLE_ITEMS) {
        els.prevBtn.classList.remove('hidden');
        els.nextBtn.classList.remove('hidden');
      } else {
        els.prevBtn.classList.add('hidden');
        els.nextBtn.classList.add('hidden');
      }
      
      // Calculate which items to show based on current index
      const startIdx = state.continueIndex;
      const endIdx = Math.min(startIdx + VISIBLE_ITEMS, list.length);
      const visibleItems = list.slice(startIdx, endIdx);
      
      // If we're at the end, loop back to start
      if (visibleItems.length < VISIBLE_ITEMS && list.length > VISIBLE_ITEMS) {
        const remaining = VISIBLE_ITEMS - visibleItems.length;
        visibleItems.push(...list.slice(0, remaining));
      }
      
      visibleItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'content-card bg-gray-900 rounded-lg overflow-hidden cursor-pointer relative group min-w-[150px] transition-transform hover:scale-105 hover:z-10';
        
        // Determine badge text
        let badge = '';
        if (item.type === 'movie') {
          badge = 'MOVIE';
        } else if (item.type === 'tv') {
          badge = item.lastEpisode ? `S${item.lastSeason}â€¢E${item.lastEpisode}` : 'TV';
        }
        
        const poster = img(item.poster);
        const progress = item.progress ? `
          <div class="absolute bottom-0 left-0 right-0">
            <div class="h-1 bg-gray-800">
              <div class="h-full bg-primary" style="width:${item.progress}%"></div>
            </div>
          </div>` : '';
        
        card.innerHTML = `
          <div class='relative h-full'>
            <img src='${poster}' alt='${item.title}' class='w-full h-full object-cover blur-load group-hover:brightness-110 transition' 
                 onload="this.classList.add('loaded')" 
                 onerror="this.src='${img(null)}';this.classList.add('loaded')"/>
            <div class='absolute top-2 right-2 bg-black/80 px-2 py-1 rounded text-xs font-bold uppercase'>${badge}</div>
            ${progress}
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-3">
              <div>
                <h3 class='font-medium text-sm truncate'>${item.title}</h3>
                <p class='text-gray-400 text-xs'>${item.year || ''}</p>
              </div>
            </div>
          </div>`;
          
        card.onclick = () => {
          if (item.type === 'tv') {
            // For TV shows, open to the last watched episode
            showTVShowSeasons(
              item.ids.tmdb, 
              item.title, 
              item.year, 
              item.poster, 
              item.ids,
              item.lastSeason || 1,
              item.lastEpisode || 1
            );
          } else {
            showMovieDetails(item.ids.tmdb, item);
          }
        };
        els.continueContainer.appendChild(card);
      });
    }

    function navigateContinue(direction) {
      const list = getContinue();
      if (list.length <= VISIBLE_ITEMS) return;
      
      state.continueIndex += direction;
      
      // Handle wrapping around
      if (state.continueIndex >= list.length) {
        state.continueIndex = 0;
      } else if (state.continueIndex < 0) {
        state.continueIndex = list.length - VISIBLE_ITEMS;
      }
      
      renderContinue();
    }

    // ================= Content Loading =================
    async function loadHeroContent() {
      try {
        // Get trending movies for the day
        const { data } = await TMDB.get('/trending/movie/day');
        const movies = data.results || [];
        
        if (movies.length > 0) {
          // Pick a random movie for the hero
          const randomIndex = Math.floor(Math.random() * Math.min(5, movies.length));
          const movie = movies[randomIndex];
          
          state.heroContent = {
            type: 'movie',
            title: movie.title,
            overview: movie.overview,
            backdrop: movie.backdrop_path ? img(movie.backdrop_path, 'original') : img(null),
            poster: movie.poster_path ? img(movie.poster_path) : img(null),
            year: movie.release_date ? new Date(movie.release_date).getFullYear() : '',
            ids: { tmdb: movie.id }
          };
          
          // Update hero section
          els.heroTitle.textContent = state.heroContent.title;
          els.heroOverview.textContent = state.heroContent.overview;
          els.heroBackdrop.querySelector('img').src = state.heroContent.backdrop;
          
          // Set up hero buttons
          els.heroPlayBtn.onclick = () => playMovie(state.heroContent);
          els.heroInfoBtn.onclick = () => showMovieDetails(state.heroContent.ids.tmdb, state.heroContent);
        }
      } catch (error) {
        console.error('Error loading hero content:', error);
      }
    }
    
    async function loadLatestContent() {
      try {
        // Get latest movies
        const { data } = await TMDB.get('/movie/now_playing');
        const movies = data.results || [];
        
        state.latestMovies = movies.slice(0, 5).map(movie => ({
          type: 'movie',
          title: movie.title,
          poster: movie.poster_path ? img(movie.poster_path, 'w500') : img(null),
          year: movie.release_date ? new Date(movie.release_date).getFullYear() : '',
          ids: { tmdb: movie.id }
        }));
        
        // Render latest movies
        renderContentSection(els.latestItems, state.latestMovies);
      } catch (error) {
        console.error('Error loading latest content:', error);
      }
    }
    
    async function loadPopularMovies() {
      try {
        // Get popular movies
        const { data } = await TMDB.get('/movie/popular');
        const movies = data.results || [];
        
        state.popularMovies = movies.slice(0, 5).map(movie => ({
          type: 'movie',
          title: movie.title,
          poster: movie.poster_path ? img(movie.poster_path, 'w500') : img(null),
          year: movie.release_date ? new Date(movie.release_date).getFullYear() : '',
          ids: { tmdb: movie.id }
        }));
        
        // Render popular movies
        renderContentSection(els.popularMovies, state.popularMovies);
      } catch (error) {
        console.error('Error loading popular movies:', error);
      }
    }
    
    async function loadTrendingShows() {
      try {
        // Get trending TV shows
        const { data } = await TMDB.get('/trending/tv/day');
        const shows = data.results || [];
        
        state.trendingShows = shows.slice(0, 5).map(show => ({
          type: 'tv',
          title: show.name,
          poster: show.poster_path ? img(show.poster_path, 'w500') : img(null),
          year: show.first_air_date ? new Date(show.first_air_date).getFullYear() : '',
          ids: { tmdb: show.id }
        }));
        
        // Render trending shows
        renderContentSection(els.trendingShows, state.trendingShows);
      } catch (error) {
        console.error('Error loading trending shows:', error);
      }
    }
    
    function renderContentSection(container, items) {
      container.innerHTML = items.map(item => `
        <div class="content-card bg-gray-900 rounded-lg overflow-hidden cursor-pointer relative group transition-transform hover:scale-105">
          <div class='relative h-full'>
            <img src='${item.poster}' alt='${item.title}' class='w-full h-full object-cover blur-load group-hover:brightness-110 transition' 
                 onload="this.classList.add('loaded')" 
                 onerror="this.src='${img(null)}';this.classList.add('loaded')"/>
            <div class='absolute top-2 right-2 bg-black/80 px-2 py-1 rounded text-xs font-bold uppercase'>${item.type === 'movie' ? 'MOVIE' : 'TV'}</div>
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-3">
              <div>
                <h3 class='font-medium text-sm truncate'>${item.title}</h3>
                <p class='text-gray-400 text-xs'>${item.year || ''}</p>
              </div>
            </div>
          </div>
        </div>`).join('');
      
      // Add click handlers
      Array.from(container.children).forEach((card, index) => {
        card.onclick = () => {
          if (items[index].type === 'movie') {
            showMovieDetails(items[index].ids.tmdb, items[index]);
          } else {
            showTVShowSeasons(
              items[index].ids.tmdb,
              items[index].title,
              items[index].year,
              items[index].poster,
              items[index].ids
            );
          }
        };
      });
    }

    // ================= Movie Details =================
    async function showMovieDetails(movieId, item) {
      try {
        // Show loading state
        els.detailsBackdrop.src = '';
        els.detailsPoster.src = '';
        els.detailsTitle.textContent = 'Loading...';
        els.detailsOverview.textContent = '';
        els.detailsMeta.innerHTML = '';
        els.detailsInfo.innerHTML = '';
        els.detailsCast.innerHTML = '<h4 class="font-bold mb-3">Top Cast</h4><div class="flex gap-4 overflow-x-auto pb-2">Loading cast...</div>';
        
        openDetailsModal();
        
        // Load movie details
        const { data: movie } = await TMDB.get(`/movie/${movieId}`);
        
        // Load credits
        const { data: credits } = await TMDB.get(`/movie/${movieId}/credits`);
        
        // Update backdrop and poster
        els.detailsBackdrop.src = movie.backdrop_path ? img(movie.backdrop_path, 'original') : img(null);
        els.detailsPoster.src = movie.poster_path ? img(movie.poster_path, 'w500') : img(null);
        
        // Update title and overview
        els.detailsTitle.textContent = movie.title;
        els.detailsOverview.textContent = movie.overview || 'No overview available.';
        
        // Update meta info (year, rating, runtime)
        const releaseYear = movie.release_date ? new Date(movie.release_date).getFullYear() : '';
        const runtime = movie.runtime ? `${Math.floor(movie.runtime / 60)}h ${movie.runtime % 60}m` : '';
        const rating = movie.vote_average ? `${movie.vote_average.toFixed(1)}/10` : '';
        
        els.detailsMeta.innerHTML = `
          ${releaseYear ? `<span>${releaseYear}</span>` : ''}
          ${rating ? `<span class="flex items-center gap-1"><i class="fas fa-star text-yellow-400"></i> ${rating}</span>` : ''}
          ${runtime ? `<span>${runtime}</span>` : ''}
        `;
        
        // Update additional info
        const genres = movie.genres?.map(g => g.name).join(', ') || 'N/A';
        const director = credits.crew?.find(p => p.job === 'Director')?.name || 'N/A';
        
        els.detailsInfo.innerHTML = `
          <div>
            <h5 class="text-gray-400 text-sm">Genre</h5>
            <p>${genres}</p>
          </div>
          <div>
            <h5 class="text-gray-400 text-sm">Director</h5>
            <p>${director}</p>
          </div>
          <div>
            <h5 class="text-gray-400 text-sm">Status</h5>
            <p>${movie.status || 'N/A'}</p>
          </div>
          <div>
            <h5 class="text-gray-400 text-sm">Language</h5>
            <p>${movie.original_language?.toUpperCase() || 'N/A'}</p>
          </div>
        `;
        
        // Update cast
        const topCast = credits.cast?.slice(0, 10) || [];
        els.detailsCast.innerHTML = `
          <h4 class="font-bold mb-3">Top Cast</h4>
          <div class="flex gap-4 overflow-x-auto pb-2">
            ${topCast.map(person => `
              <div class="flex flex-col items-center min-w-[80px]">
                <img src="${person.profile_path ? img(person.profile_path, 'w185') : img(null, 'w185')}" 
                     class="w-16 h-16 rounded-full object-cover mb-2" 
                     alt="${person.name}"
                     onerror="this.src='${img(null, 'w185')}'">
                <p class="text-sm font-medium text-center">${person.name}</p>
                <p class="text-xs text-gray-400 text-center">${person.character || ''}</p>
              </div>
            `).join('')}
          </div>
        `;
        
        // Set up play button
        els.playNowBtn.onclick = () => {
          closeDetailsModal();
          playMovie({
            type: 'movie',
            title: movie.title,
            year: releaseYear,
            poster: movie.poster_path ? img(movie.poster_path) : img(null),
            ids: { tmdb: movie.id }
          });
        };
        
        // Set up trailer button (placeholder - would need YouTube API integration)
        els.trailerBtn.onclick = () => {
          alert('Trailer functionality would be implemented with YouTube API');
        };
        
      } catch (error) {
        console.error('Error loading movie details:', error);
        els.detailsOverview.textContent = 'Failed to load movie details. Please try again.';
      }
    }

    // ================= Utils =================
    function img(path, size = 'w500') {
      if (!path) {
        return 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MDAgNzUwIj48cmVjdCB3aWR0aD0iNTAwIiBoZWlnaHQ9Ijc1MCIgZmlsbD0iIzJkM2Q0MSIvPjx0ZXh0IHg9IjI1MCIgeT0iMzc1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMzAiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIFBvc3RlcjwvdGV4dD48L3N2Zz4=';
      }
      return `https://image.tmdb.org/t/p/${size}${path}`;
    }

    // ================= Search =================
    async function searchContent(q) {
      const box = els.searchResults;
      const input = els.searchInput;
      
      if(!q || q.length < 2) { 
        box.classList.add('hidden'); 
        return; 
      }

      box.classList.remove('hidden');
      box.innerHTML = `
        <div class="p-6 flex items-center justify-center gap-3 text-gray-400">
          <div class="w-6 h-6 border-2 border-gray-400 border-t-primary rounded-full animate-spin-slow"></div>
          <span>Searching...</span>
        </div>`;

      try {
        const { data } = await TMDB.get('/search/multi', { 
          params: { 
            query: q,
            include_adult: false,
            page: 1
          }
        });

        const items = data.results || [];
        if (items.length === 0) {
          box.innerHTML = `
            <div class="p-6 text-center text-gray-400">
              No results found for "${q}"
            </div>`;
          return;
        }

        // Filter only movies and TV shows
        const filteredItems = items.filter(item => 
          (item.media_type === 'movie' || item.media_type === 'tv') && 
          (item.poster_path || item.backdrop_path)
        );

        if (filteredItems.length === 0) {
          box.innerHTML = `
            <div class="p-6 text-center text-gray-400">
              No results found for "${q}"
            </div>`;
          return;
        }

        box.innerHTML = filteredItems.map(item => {
          const title = item.title || item.name || 'Untitled';
          const year = item.release_date ? new Date(item.release_date).getFullYear() : 
                      item.first_air_date ? new Date(item.first_air_date).getFullYear() : '';
          const poster = item.poster_path ? img(item.poster_path, 'w200') : img(null);
          const type = item.media_type === 'movie' ? 'Movie' : 'TV Show';
          const id = item.id;
          
          return `
            <div class="p-4 hover:bg-gray-900 cursor-pointer flex items-center gap-4 border-b border-gray-900 last:border-0 transition-colors" 
                 data-media="${item.media_type}" 
                 data-id="${id}">
              <img src="${poster}" 
                   class="w-16 h-20 object-cover rounded-md" 
                   alt="${title}" 
                   onerror="this.src='${img(null)}'"/>
              <div class="flex-1 min-w-0">
                <div class="font-medium truncate">${title}</div>
                <div class="text-sm text-gray-500">${year} â€¢ ${type}</div>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
              </svg>
            </div>`;
        }).join('');

        Array.from(box.children).forEach(row => {
          row.addEventListener('click', async (e) => {
            e.stopPropagation();
            const type = row.getAttribute('data-media');
            const id = row.getAttribute('data-id');
            
            try {
              if (type === 'movie') {
                const { data: movie } = await TMDB.get(`/movie/${id}`);
                showMovieDetails(id, { 
                  type: 'movie',
                  title: movie.title,
                  year: movie.release_date ? new Date(movie.release_date).getFullYear() : '',
                  poster: movie.poster_path ? img(movie.poster_path) : img(null),
                  ids: { tmdb: id }
                });
              } else {
                const { data: tvShow } = await TMDB.get(`/tv/${id}`);
                showTVShowSeasons(
                  id, 
                  tvShow.name, 
                  tvShow.first_air_date ? new Date(tvShow.first_air_date).getFullYear() : '', 
                  tvShow.poster_path ? img(tvShow.poster_path) : img(null), 
                  { tmdb: id }
                );
              }
              
              input.value = '';
              box.classList.add('hidden');
            } catch (error) {
              console.error('Error loading details:', error);
              box.innerHTML = `
                <div class="p-6 text-center text-red-400">
                  Error loading details: ${error.message}
                </div>`;
            }
          });
        });

      } catch (error) {
        console.error('Search error:', error);
        box.innerHTML = `
          <div class="p-6 text-center text-red-400">
            ${error.message || 'Search failed. Please try again.'}
          </div>`;
      }
    }

    function debounceSearch() {
      clearTimeout(state.searchTimeout);
      state.searchTimeout = setTimeout(() => {
        const query = els.searchInput.value.trim();
        searchContent(query);
      }, 500);
    }

    // ================= Player Functions =================
    async function playMovie(item) {
      let url;
      if (state.currentPlayer === 'videasy') {
        url = buildVidEasyUrl('movie', item.ids.tmdb);
      } else {
        url = buildVidSrcUrl('movie', item.ids.tmdb);
      }
      
      els.player.src = url;
      els.playerTitle.textContent = `${item.title}${item.year ? ` (${item.year})` : ''}`;
      els.playerInfo.textContent = '';
      els.episodeNav.classList.add('hidden');
      els.episodeSelector.classList.add('hidden');
      
      state.currentShow = { 
        type: 'movie',
        title: item.title, 
        year: item.year, 
        poster: item.poster, 
        ids: {...item.ids} 
      };
      
      openModal();
      recordContinue({ 
        type: 'movie', 
        title: item.title, 
        year: item.year, 
        poster: item.poster, 
        ids: {...item.ids},
        progress: 0
      });
    }

    async function showTVShowSeasons(id, title, year, poster, idsIn, season = 1, episode = 1) {
      if (!id) {
        console.error('No ID available for TV show');
        return;
      }

      state.currentTVShow = { 
        type: 'tv',
        title, 
        year, 
        poster, 
        tmdbId: id,
        ids: { tmdb: id }
      };

      els.playerTitle.textContent = `${title}${year ? ` (${year})` : ''}`;
      els.playerInfo.textContent = 'Select an episode';
      els.episodeNav.classList.remove('hidden');
      els.episodeSelector.classList.add('hidden');
      els.showEpisodesBtn.textContent = 'Show All Episodes';
      
      try {
        const { data: showData } = await TMDB.get(`/tv/${id}`);
        state.totalSeasons = showData.number_of_seasons || 1;
        
        // Populate season dropdown
        els.seasonSelect.innerHTML = '';
        for (let i = 1; i <= state.totalSeasons; i++) {
          els.seasonSelect.innerHTML += `<option value="${i}" ${i === season ? 'selected' : ''}>Season ${i}</option>`;
        }
        
        // Load episodes for the specified season
        await loadEpisodesForSeason(id, season);
        
        // Play the specified episode if provided
        if (episode) {
          setTimeout(() => {
            playSelectedEpisode(episode);
          }, 100);
        }
        
        // Add event listeners
        els.seasonSelect.addEventListener('change', async (e) => {
          const season = parseInt(e.target.value);
          state.currentSeason = season;
          await loadEpisodesForSeason(id, season);
          updateEpisodeSelect();
        });
        
        els.episodeSelect.addEventListener('change', (e) => {
          const episode = parseInt(e.target.value);
          playSelectedEpisode(episode);
        });
        
        els.prevEpisodeBtn.addEventListener('click', () => navigateEpisode(-1));
        els.nextEpisodeBtn.addEventListener('click', () => navigateEpisode(1));
        
      } catch (e) {
        console.error('Error loading show details:', e);
        els.episodesList.innerHTML = `<div class='col-span-full text-red-400'>Failed to load seasons.</div>`;
      }
      
      openModal();
    }

    function updateEpisodeSelect() {
      els.episodeSelect.innerHTML = '';
      for (let i = 1; i <= state.totalEpisodes; i++) {
        els.episodeSelect.innerHTML += `<option value="${i}" ${i === state.currentEpisode ? 'selected' : ''}>Episode ${i}</option>`;
      }
      updateNavButtons();
    }

    function updateNavButtons() {
      els.prevEpisodeBtn.disabled = state.currentEpisode === 1;
      els.nextEpisodeBtn.disabled = state.currentEpisode === state.totalEpisodes;
    }

    function navigateEpisode(direction) {
      const newEpisode = state.currentEpisode + direction;
      if (newEpisode > 0 && newEpisode <= state.totalEpisodes) {
        playSelectedEpisode(newEpisode);
      }
    }

    function playSelectedEpisode(episodeNumber) {
      const episode = state.episodes.find(e => e.episode_number === episodeNumber);
      if (!episode) return;
      
      const item = {
        type: 'episode',
        title: episode.name || state.currentTVShow.title,
        year: state.currentTVShow.year,
        poster: state.currentTVShow.poster,
        season: state.currentSeason,
        episode: episodeNumber,
        ids: { tmdb: state.currentTVShow.tmdbId }
      };
      
      playEpisode(item);
    }

    async function loadEpisodesForSeason(showId, season) {
      els.episodesList.innerHTML = `
        <div class="col-span-full p-6 flex items-center justify-center gap-3 text-gray-400">
          <div class="w-6 h-6 border-2 border-gray-400 border-t-primary rounded-full animate-spin-slow"></div>
          <span>Loading episodes...</span>
        </div>`;
      
      try {
        const { data } = await TMDB.get(`/tv/${showId}/season/${season}`);
        
        if (data.episodes) {
          state.episodes = data.episodes.map(ep => ({
            episode_number: ep.episode_number,
            name: ep.name || `Episode ${ep.episode_number}`,
            overview: ep.overview || ''
          }));
          
          state.totalEpisodes = state.episodes.length;
          state.currentSeason = season;
          
          renderEpisodeList();
          updateEpisodeSelect();
        } else {
          els.episodesList.innerHTML = `<div class='col-span-full text-center py-6 text-gray-400'>No episodes found for this season.</div>`;
        }
      } catch (e) {
        console.error('Error loading episodes:', e);
        els.episodesList.innerHTML = `<div class='col-span-full text-center py-6 text-red-400'>Failed to load episodes.</div>`;
      }
    }

    function renderEpisodeList() {
      els.episodesList.innerHTML = state.episodes.map(ep => `
        <div class='bg-gray-800 hover:bg-gray-700 rounded-md overflow-hidden cursor-pointer transition-colors ${ep.episode_number === state.currentEpisode ? 'border border-primary' : ''}' 
             data-ep='${ep.episode_number}'>
          <div class='p-3'>
            <div class='font-medium text-sm mb-1'>Episode ${ep.episode_number}</div>
            <div class='text-xs text-gray-400 truncate'>${ep.name || ''}</div>
          </div>
        </div>`).join('');
      
      Array.from(els.episodesList.children).forEach(el => {
        el.addEventListener('click', () => {
          const epNo = Number(el.getAttribute('data-ep'));
          playSelectedEpisode(epNo);
        });
      });
    }

    async function playEpisode(item) {
      let url;
      if (state.currentPlayer === 'videasy') {
        url = buildVidEasyUrl('tv', item.ids.tmdb, item.season, item.episode);
      } else {
        url = buildVidSrcUrl('tv', item.ids.tmdb, item.season, item.episode);
      }
      
      els.player.src = url;
      els.playerTitle.textContent = `${item.title}`;
      els.playerInfo.textContent = `Season ${item.season} â€¢ Episode ${item.episode}${item.year ? ` â€¢ ${item.year}` : ''}`;
      
      // Update current episode state
      state.currentSeason = item.season;
      state.currentEpisode = item.episode;
      
      // Update UI
      els.seasonSelect.value = item.season;
      updateEpisodeSelect();
      renderEpisodeList();
      
      state.currentShow = { 
        type: 'episode',
        title: item.title,
        year: item.year,
        poster: item.poster,
        season: item.season,
        episode: item.episode,
        ids: { tmdb: item.ids.tmdb }
      };
      
      openModal();
      recordContinue({ 
        type: 'episode', 
        title: item.title, 
        year: item.year, 
        poster: item.poster, 
        season: item.season, 
        episode: item.episode, 
        ids: {...item.ids},
        progress: 0
      });
    }

    // ================= Init =================
    document.addEventListener('DOMContentLoaded', () => {
      // Close search when clicking outside
      document.addEventListener('click', (e) => {
        if (!els.searchInput.contains(e.target) && !els.searchResults.contains(e.target)) {
          els.searchResults.classList.add('hidden');
        }
      });

      // Setup profile management
      setupAvatarSelection();
      setupPinInputs();
      
      els.addProfileBtn.addEventListener('click', () => {
        els.addProfileModal.classList.remove('hidden');
      });
      
      els.cancelAddProfileBtn.addEventListener('click', () => {
        els.addProfileModal.classList.add('hidden');
      });
      
      els.saveProfileBtn.addEventListener('click', addNewProfile);
      
      els.cancelPinBtn.addEventListener('click', () => {
        els.pinModal.classList.add('hidden');
        state.selectedProfileForPin = null;
      });
      
      els.submitPinBtn.addEventListener('click', verifyPin);
      
      els.switchProfileBtn.addEventListener('click', switchProfile);
      
      els.prevBtn.addEventListener('click', () => navigateContinue(-1));
      els.nextBtn.addEventListener('click', () => navigateContinue(1));
      
      els.closePlayerBtn.addEventListener('click', closeModal);
      
      els.closeDetailsBtn.addEventListener('click', closeDetailsModal);
      
      els.showEpisodesBtn.addEventListener('click', () => {
        els.episodeSelector.classList.toggle('hidden');
        els.showEpisodesBtn.textContent = els.episodeSelector.classList.contains('hidden') 
          ? 'Show All Episodes' 
          : 'Hide Episodes';
      });
      
      // Player type change handler
      els.playerType.addEventListener('change', (e) => {
        state.currentPlayer = e.target.value;
        if (state.currentShow) {
          if (state.currentShow.type === 'movie') {
            playMovie(state.currentShow);
          } else if (state.currentShow.type === 'episode') {
            playEpisode(state.currentShow);
          }
        }
      });
      
      // Refresh button handler
      els.refreshBtn.addEventListener('click', () => {
        if (state.currentProfile) {
          loadHeroContent();
          loadLatestContent();
          loadPopularMovies();
          loadTrendingShows();
        }
      });
      
      renderProfiles();
      
      const profiles = getProfiles();
      if (profiles.length === 1 && !profiles[0].pin) {
        startSession(profiles[0]);
      }
    });
  </script>
</body>
</html>